<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wykies Automation — Products</title>
  <link rel="stylesheet" href="./assets/css/styles.css">
</head>
<body>
<header>
  <div class="wrap logo">
    <img src="./assets/img/logo-blue.svg" alt="Wykies Automation">
    <span class="h1">Wykies Automation — LIVE Catalog & PayFast</span>
  </div>
  <div class="wrap"><nav>
    <a href="index.html">Home</a>
    <a href="gallery.html">Gallery</a>
    <a href="admin.html">Admin</a>
  </nav></div>
</header>
<main>
  <div class="wrap">
    <p>Browse our catalog. Prices include VAT. Download trials and documentation, or checkout via PayFast.</p>
    <div id="prod-grid" class="grid"></div>

    <h3>Contact</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div>
        <label>Name<br><input id="c-name" class="input" placeholder="Your name"></label>
        <label>Email<br><input id="c-email" class="input" placeholder="you@example.com"></label>
        <label>Phone<br><input id="c-phone" class="input" placeholder="071 000 0000"></label>
      </div>
      <div>
        <label>Product<br><input id="c-product" class="input" placeholder="SKU or name"></label>
        <label>Message<br><textarea id="c-msg" class="input" rows="4" placeholder="How can we help?"></textarea></label>
        <label><input type="checkbox" id="c-copy"> Copy me</label>
        <label><input type="checkbox" id="c-wa"> WhatsApp opt‑in</label>
        <div class="btn-row">
          <button class="btn primary" id="c-send">Send Email</button>
          <a class="btn" id="wa-open" target="_blank">Open WhatsApp</a>
        </div>
      </div>
    </div>
  </div>
</main>
<footer>
  <div class="wrap">© 2025 Wykies Automation • VAT included • Contact: <a href="mailto:wykiesautomation@gmail.com">wykiesautomation@gmail.com</a> • WhatsApp: <a id="wa-foot" target="_blank">Chat</a></div>
</footer>
<script type="module">
  import { qs, snackbar } from './assets/js/ui.js';
  import { CFG, fetchProducts, contact, initNav } from './assets/js/cms.js';
  import { redirectToPayFast } from './assets/js/payfast.js';

  function productCard(p){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <img src="${p.imageUrl||'./assets/img/placeholder.jpg'}" alt="${p.name}">
      <div class="pad">
        <h3>${p.name} <span class="price">${p.price}</span></h3>
        <p>${p.summary||''}</p>
        <div class="btn-row">
          <a class="btn" href="product.html?sku=${encodeURIComponent(p.sku)}">View</a>
          <a class="btn ghost" href="${p.trialUrl||'#'}" target="_blank">Trial</a>
          <a class="btn ghost" href="${p.docUrl||'#'}" target="_blank">Docs</a>
          <button class="btn primary" data-sku="${p.sku}" data-name="${p.name}" data-price="${p.price}">Buy via PayFast</button>
        </div>
      </div>`;
    return el;
  }

  async function render(){
    await initNav();
    const prods = await fetchProducts();
    const grid = qs('#prod-grid'); grid.innerHTML='';
    prods.filter(p=>p.active).forEach(p=> grid.appendChild(productCard(p)) );
    qs('#wa-foot').href = `https://wa.me/${CFG.contact.whatsapp_number}`;
    qs('#wa-open').href = `https://wa.me/${CFG.contact.whatsapp_number}`;

    grid.querySelectorAll('button[data-sku]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sku = btn.dataset.sku, name = btn.dataset.name, amount = btn.dataset.price;
        const email = qs('#c-email').value.trim();
        redirectToPayFast({ sku, name, amount: amount.replace(/[^0-9.]/g,''), buyerEmail: email });
      });
    });

    qs('#c-send').addEventListener('click', async ()=>{
      const payload = {
        name: qs('#c-name').value.trim(),
        email: qs('#c-email').value.trim(),
        phone: qs('#c-phone').value.trim(),
        product: qs('#c-product').value.trim(),
        message: qs('#c-msg').value.trim(),
        copyMe: qs('#c-copy').checked,
        waOpt: qs('#c-wa').checked
      };
      const res = await contact(payload);
      snackbar(res && res.ok ? 'Message sent' : 'Failed to send');
    });
  }
  render();
</script>
</body>
</html>