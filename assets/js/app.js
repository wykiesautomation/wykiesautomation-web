
const state = { cfg:null, products:[], payments:[], priceChanges:[] };
async function loadConfig(){ try{ const r=await fetch('assets/js/config.json'); state.cfg=await r.json(); }catch(e){ console.warn('Config load failed',e); } }
function priceFmt(n){ return 'R'+Number(n).toLocaleString('en-ZA'); }
function q(sel){ return document.querySelector(sel); }
function el(tag,attrs={},children=[]) { const e=document.createElement(tag); for(const[k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else if(k==='text') e.textContent=v; else if(k.startsWith('on')) e.addEventListener(k.substring(2), v); else e.setAttribute(k,v); } for(const c of children) e.appendChild(typeof c==='string'?document.createTextNode(c):c); return e; }
async function fetchJSON(url){ const r=await fetch(url); return r.json(); }
async function loadProducts(){ if(state.cfg && state.cfg.appsScriptUrl){ try{ const r=await fetch(state.cfg.appsScriptUrl+'?resource=products'); if(r.ok){ state.products=await r.json(); return; } }catch(e){ console.warn('Apps Script fetch failed',e); } } q('#banner').style.display='block'; state.products=await fetchJSON('assets/js/products.json'); }
function productCard(p){ const card=el('div',{class:'card'}); const wrap=el('div',{style:'position:relative'}); const img=el('img',{loading:'lazy',alt:p.name,src:p.imageUrl,onerror:(ev)=>{ev.target.src='assets/img/products/no-image.png';}}); wrap.appendChild(img); wrap.appendChild(el('div',{class:'price-badge',text:priceFmt(p.price)})); card.appendChild(wrap); card.appendChild(el('div',{class:'pad'},[ el('div',{class:'badge',text:p.sku}), el('h3',{text:p.name}), el('p',{text:p.summary||''}) ])); const row=el('div',{class:'actions'},[ el('a',{class:'btn ghost',href:`product.html?sku=${encodeURIComponent(p.sku)}`},['View Details']), el('a',{class:'btn',href:`https://wa.me/27716816131?text=I%20am%20interested%20in%20${encodeURIComponent(p.sku+' '+p.name)}`,'target':'_blank','rel':'noopener'},['WhatsApp']) ]); if(p.trialUrl && p.trialUrl!=='#') row.appendChild(el('a',{class:'btn ghost',href:p.trialUrl},['Download Trial'])); if(p.docUrl && p.docUrl!=='#') row.appendChild(el('a',{class:'btn ghost',href:p.docUrl},['View Docs'])); card.appendChild(row); return card; }
function renderProducts(list){ const grid=q('#productGrid'); if(!grid) return; grid.innerHTML=''; list.forEach(p=>grid.appendChild(productCard(p))); }
function filterProducts(term){ term=(term||'').toLowerCase(); const out = !term? state.products : state.products.filter(p=> (p.name+p.summary+p.sku).toLowerCase().includes(term)); renderProducts(out); }
function clearSearch(){ q('#search').value=''; filterProducts(''); }
async function initIndex(){ await loadConfig(); await loadProducts(); filterProducts(''); }
async function initProduct(){ await loadConfig(); await loadProducts(); const params=new URLSearchParams(location.search); const sku=params.get('sku'); const p= state.products.find(x=>x.sku===sku) || state.products[0]; const c=q('#product'); if(!p||!c) return; c.innerHTML=''; c.appendChild(el('div',{class:'card'},[ el('img',{src:p.imageUrl,alt:p.name,onerror:(ev)=>{ev.target.src='assets/img/products/no-image.png';}}), el('div',{class:'pad'},[ el('div',{class:'badge',text:p.sku}), el('h2',{text:p.name}), el('p',{text:p.description||p.summary||''}), el('div',{class:'badge'},['Price: '+priceFmt(p.price)]) ]), el('div',{class:'actions'},[ el('a',{class:'btn',href:`https://wa.me/27716816131?text=I%20want%20to%20order%20${encodeURIComponent(p.sku)}%20${encodeURIComponent(p.name)}`,'target':'_blank','rel':'noopener'},['Order via WhatsApp']) ]) ])); }
async function initGallery(){ await loadConfig(); const c=q('#gallery'); if(!c) return; for(let i=1;i<=6;i++){ const idx=String(i).padStart(2,'0'); const card=el('div',{class:'card'},[ el('img',{src:`assets/img/gallery/gallery-${idx}.png`,alt:`Gallery ${idx}`,loading:'lazy',onerror:(ev)=>{ev.target.src='assets/img/products/no-image.png';}}), el('div',{class:'pad'},[el('p',{text:`Gallery ${idx}`})]) ]); c.appendChild(card);} }
if(location.pathname.endsWith('/') || location.pathname.endsWith('/index.html')){ initIndex(); } else if(location.pathname.endsWith('/product.html')){ initProduct(); } else if(location.pathname.endsWith('/gallery.html')){ initGallery(); }
