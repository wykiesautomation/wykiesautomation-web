(function(){const grid=document.getElementById('productGrid');const status=document.getElementById('contactStatus');const yearEl=document.getElementById('year');if(yearEl)yearEl.textContent=new Date().getFullYear();async function loadProducts(){try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/cms/products&sheetId=${encodeURIComponent(WA_CONFIG.sheetId)}`);const data=await res.json();if(!Array.isArray(data))throw new Error('Bad products response');grid.innerHTML=data.map(p=>`<article class="card product" data-code="${p.code}"><img src="${p.image||'https://placehold.co/600x400?text=Wykies+Automation'}" alt="${p.name||p.code}"><div class="title">${p.name||''}</div><div class="code">${p.code}</div><div class="price">R ${Number(p.price).toLocaleString('en-ZA',{minimumFractionDigits:2})}</div><button class="btn" data-preorder="${p.code}">Pre‑Order</button></article>`).join('');grid.addEventListener('click',(e)=>{const btn=e.target.closest('[data-preorder]');if(btn){const code=btn.getAttribute('data-preorder');const product=data.find(x=>x.code===code);const productInput=document.querySelector('input[name="product"]');if(productInput){productInput.value=product?.code||code;}window.scrollTo({top:document.getElementById('contact').offsetTop-20,behavior:'smooth'});}});}catch(err){grid.innerHTML=`<p class="muted">Could not load products. Try again later.</p>`;console.error(err);}}async function submitContact(evt){evt.preventDefault();status.textContent='Sending…';const form=evt.currentTarget;const payload=Object.fromEntries(new FormData(form).entries());try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/forms/contact&sheetId=${encodeURIComponent(WA_CONFIG.sheetId)}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const out=await res.json();status.textContent=out?.message||'Thanks! We\'ll be in touch.';form.reset();}catch(err){console.error(err);status.textContent='Failed to send. Please try again.';}}document.getElementById('contactForm').addEventListener('submit',submitContact);loadProducts();})();