
(async function(){
  const cfg = await fetch('config.json').then(r=>r.json());
  const api = (params={})=>{ const u=new URL(cfg.webAppUrl); Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v)); return fetch(u).then(r=>r.json()); };
  const fmtPrice = v=> new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR'}).format(Number(v||0));
  function payfastInputs(p,cfg){ const orderId=`${p.sku}-${Date.now()}`; const f={ merchant_id:cfg.payfast.merchant_id, merchant_key:cfg.payfast.merchant_key, amount:Number(p.price||0).toFixed(2), item_name:p.name||p.sku, item_description:`Order for ${p.sku}`, return_url:cfg.payfast.return_url, cancel_url:cfg.payfast.cancel_url, notify_url:cfg.payfast.notify_url, custom_str1:p.sku, m_payment_id:orderId, email_confirmation:1, confirmation_address:cfg.company.email }; return Object.entries(f).map(([k,v])=>`<input type='hidden' name='${k}' value='${String(v).replace(/'/g,"&#39;")}'/>`).join('')+`<button class='btn' type='submit'>Buy</button>`; }
  async function renderGrid(){ const data=await api({action:'getProducts'}); const grid=document.getElementById('product-grid'); if(!grid) return; grid.innerHTML=''; data.products.filter(p=>String(p.active).toLowerCase()==='true').forEach(p=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<img src='${p.imageUrl||''}' alt='${p.name||p.sku}' onerror="this.style.display='none'" style='width:100%;height:180px;object-fit:cover;border-radius:10px'/><h3>${p.name||p.sku}</h3><p class='price'>${fmtPrice(p.price)}</p><p class='muted'>${p.summary||''}</p><div style='display:flex;gap:8px;flex-wrap:wrap'><a class='btn secondary' href='product.html?sku=${encodeURIComponent(p.sku)}'>View</a>${p.trialUrl?`<a class='btn' target='_blank' href='${p.trialUrl}'>Trial</a>`:''}${p.docUrl?`<a class='btn secondary' target='_blank' href='${p.docUrl}'>Docs</a>`:''}<form method='post' action='https://www.payfast.co.za/eng/process' style='display:inline'>${payfastInputs(p,cfg)}</form></div>`; grid.appendChild(card); }); }
  async function renderProduct(){ const url=new URL(location.href); const sku=url.searchParams.get('sku'); const data=await api({action:'getProducts'}); const p=data.products.find(x=>String(x.sku)===sku)||data.products[0]; if(!p) return; document.getElementById('prod-image').src=p.imageUrl||''; document.getElementById('prod-name').textContent=`${p.name} (${p.sku})`; document.getElementById('prod-price').textContent=fmtPrice(p.price); document.getElementById('prod-desc').textContent=p.description||p.summary||''; const btnT=document.getElementById('btn-trial'); if(p.trialUrl) btnT.href=p.trialUrl; else btnT.style.display='none'; const btnD=document.getElementById('btn-doc'); if(p.docUrl) btnD.href=p.docUrl; else btnD.style.display='none'; const form=document.getElementById('payfast-form'); form.innerHTML=payfastInputs(p,cfg); }
  async function renderGallery(){ const data=await api({action:'getGallery'}); const grid=document.getElementById('gallery-grid'); if(!grid) return; grid.innerHTML=''; data.gallery.forEach(g=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<img src='${g.url}' alt='${g.caption||''}'/><p class='muted'>${g.caption||''}</p>`; grid.appendChild(card); }); }
  if(document.getElementById('product-grid')) renderGrid();
  if(document.getElementById('prod-name')) renderProduct();
  if(document.getElementById('gallery-grid')) renderGallery();
})();
