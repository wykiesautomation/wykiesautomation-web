
(async function(){
  const cfg = await fetch('config.json').then(r=>r.json());
  const state = { token:null };
  const api = async (params={}, method='GET', body=null)=>{ const u=new URL(cfg.webAppUrl); Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v)); if(state.token) u.searchParams.set('token', state.token); const opt={method, headers:{'Content-Type':'application/json'}}; if(body) opt.body=JSON.stringify(body); const res=await fetch(u,opt); return res.json(); };
  document.getElementById('btn-login')?.addEventListener('click', async()=>{ const pass=document.getElementById('passphrase').value; const r=await api({action:'login'}, 'POST', {passphrase:pass}); const s=document.getElementById('login-status'); if(r.ok){ state.token=r.token; document.getElementById('login-panel').style.display='none'; document.getElementById('admin-content').style.display='block'; loadProducts(); loadGallery(); loadPayments(); } else { s.textContent=r.error||'Login failed'; }});
  async function loadProducts(){ const data=await api({action:'getProducts'}); const tb=document.querySelector('#products-table tbody'); tb.innerHTML=''; data.products.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.sku}</td><td><input value='${p.name||''}'></td><td><input type='number' step='0.01' value='${p.price||''}'></td><td><input value='${p.imageUrl||''}'></td><td><input value='${p.trialUrl||''}'></td><td><input value='${p.docUrl||''}'></td><td><select><option ${String(p.active).toLowerCase()==='true'?'selected':''}>true</option><option ${String(p.active).toLowerCase()!=='true'?'selected':''}>false</option></select></td><td><button class='btn'>Save</button></td>`; const [nameI, priceI, imgI, trialI, docI, activeS, btn] = tr.querySelectorAll('input,select,button'); btn.onclick=async()=>{ const body={sku:p.sku,name:nameI.value,price:priceI.value,imageUrl:imgI.value,trialUrl:trialI.value,docUrl:docI.value,active:activeS.value}; const r=await api({action:'saveProduct'}, 'POST', body); if(!r.ok) alert('Save failed: '+(r.error||'')); }; tb.appendChild(tr); }); }
  document.getElementById('btn-add-image')?.addEventListener('click', async()=>{ const url=document.getElementById('gallery-url').value.trim(); const caption=document.getElementById('gallery-caption').value.trim(); if(!url) return alert('Enter image URL'); const r=await api({action:'addGallery'}, 'POST', {url, caption}); if(r.ok){ document.getElementById('gallery-url').value=''; document.getElementById('gallery-caption').value=''; loadGallery(); } else alert('Add failed: '+(r.error||'')); });
  async function loadGallery(){ const data=await api({action:'getGallery'}); const grid=document.getElementById('gallery-admin'); grid.innerHTML=''; data.gallery.forEach(g=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<img src='${g.url}'/><div style='display:flex;justify-content:space-between;align-items:center'><span class='muted'>${g.caption||''}</span><button class='btn secondary'>Delete</button></div>`; card.querySelector('button').onclick=async()=>{ const r=await api({action:'delGallery'}, 'POST', {url:g.url}); if(r.ok) loadGallery(); else alert('Delete failed'); }; grid.appendChild(card); }); }
  async function loadPayments(){ const data=await api({action:'getPayments'}); const tb=document.querySelector('#payments-table tbody'); tb.innerHTML=''; data.payments.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.Timestamp||''}</td><td>${p.InvoiceNo||''}</td><td>${p.OrderID||''}</td><td>${p.pf_payment_id||''}</td><td>${p.Email||''}</td><td>${p.SKU||''}</td><td>${p.TotalInclVAT||''}</td><td><button class='btn secondary'>Resend</button></td>`; tr.querySelector('button').onclick=async()=>{ const r=await api({action:'resendInvoice'}, 'POST', {pf_payment_id:p.pf_payment_id}); if(!r.ok) alert('Resend failed'); }; tb.appendChild(tr); }); }
})();
