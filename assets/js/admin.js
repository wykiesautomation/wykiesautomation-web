
async function loadConfig(){ const r = await fetch('config.json'); return await r.json(); }
let loggedIn = false;
async function login(){ const pass = document.getElementById('passphrase').value; const status = document.getElementById('loginStatus'); const cfg = await loadConfig(); try{ const r = await fetch(cfg.appsScriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'login', passphrase:pass}) }); const res = r.ok ? await r.json() : {ok:false}; if(res.ok){ loggedIn = true; document.getElementById('loginBox').style.display='none'; document.getElementById('adminContent').style.display='block'; loadAdminData(); } else { status.textContent = 'Login failed'; } }catch(e){ status.textContent = 'Network error'; } }
document.getElementById('loginBtn').addEventListener('click', login);
async function loadAdminData(){ await loadProducts(); await loadPayments(); }
async function loadProducts(){ const cfg = await loadConfig(); try{ const r = await fetch(cfg.appsScriptUrl + '?action=products'); const list = await r.json(); const tbody = document.querySelector('#prodTable tbody'); tbody.innerHTML = list.map(p=>`<tr><td>${p.sku}</td><td><input class='input' value='${p.name}' data-sku='${p.sku}' data-k='name'></td><td><input class='input' type='number' value='${p.price}' data-sku='${p.sku}' data-k='price'></td><td><input class='input' value='${p.imageUrl}' data-sku='${p.sku}' data-k='imageUrl'></td><td><input class='input' value='${p.trialUrl||''}' data-sku='${p.sku}' data-k='trialUrl'></td><td><input class='input' value='${p.docUrl||''}' data-sku='${p.sku}' data-k='docUrl'></td><td><input type='checkbox' ${p.active?'checked':''} data-sku='${p.sku}' data-k='active'></td><td><button class='btn secondary' onclick='saveProduct("${p.sku}")'>Save</button></td></tr>`).join(''); }catch(e){ console.error(e); }}
async function saveProduct(sku){ const cfg = await loadConfig(); const rowInputs = Array.from(document.querySelectorAll(`[data-sku='${sku}']`)); const payload = { action:'updateProduct', sku }; rowInputs.forEach(inp=>{ const k = inp.getAttribute('data-k'); payload[k] = inp.type==='checkbox' ? inp.checked : inp.value; }); try{ const r = await fetch(cfg.appsScriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); alert(r.ok? 'Saved' : 'Save failed'); }catch(e){ alert('Network error'); } }
async function addGallery(){ const cfg = await loadConfig(); const url = document.getElementById('galUrl').value.trim(); const caption = document.getElementById('galCap').value.trim(); try{ const r = await fetch(cfg.appsScriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'addGalleryImage', url, caption}) }); document.getElementById('galStatus').textContent = r.ok? 'Added' : 'Failed'; }catch(e){ document.getElementById('galStatus').textContent = 'Network error'; } }
document.getElementById('addGalBtn').addEventListener('click', addGallery);
async function loadPayments(){ const cfg = await loadConfig(); try{ const r = await fetch(cfg.appsScriptUrl + '?action=payments'); const list = await r.json(); const tbody = document.querySelector('#payTable tbody'); tbody.innerHTML = list.map(p=>`<tr><td>${p.Timestamp||''}</td><td>${p.InvoiceNo||''}</td><td>${p.OrderID||''}</td><td>${p.pf_payment_id||''}</td><td>${p.Email||''}</td><td>${p.SKU||''}</td><td>${p.TotalInclVAT||''}</td><td><button class='btn secondary' onclick='resendInvoice("${p.InvoiceNo}")'>Resend</button></td></tr>`).join(''); }catch(e){ console.error(e); }}
async function resendInvoice(inv){ const cfg = await loadConfig(); try{ const r = await fetch(cfg.appsScriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'resendInvoice', invoiceNo:inv}) }); alert(r.ok? 'Resent' : 'Resend failed'); }catch(e){ alert('Network error'); } }
