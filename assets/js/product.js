const cfg = (async ()=> await (await fetch('/config.json')).json())();
const fmtZAR = v => new Intl.NumberFormat('en-ZA', {style:'currency', currency:'ZAR'}).format(v);
function qs(name){const url=new URL(location.href);return url.searchParams.get(name)}
async function load(){ const sku = qs('sku'); const c = await cfg; const res = await fetch(`${c.APP_SCRIPT_BASE}?route=product&sku=${encodeURIComponent(sku)}`); const p = await res.json(); const wrap = document.getElementById('product'); wrap.innerHTML = ` <div class="card"> <img src="${p.imageUrl || '/assets/images/placeholder.png'}" alt="${p.name}"/> <h2>${p.name}</h2> <div class="price">${fmtZAR(p.price)}</div> <p>${p.description||p.summary||''}</p> <div class="btnrow"> <button class="btn" onclick="payfastCheckout('${p.sku}')">Buy</button> <a class="btn secondary" href="${p.trialUrl || '#'}" target="_blank">Trial (.exe)</a> <a class="btn secondary" href="${p.docUrl || '#'}" target="_blank">Documentation</a> <a class="btn secondary" href="https://wa.me/${(await cfg).WHATSAPP_NUMBER}?text=${encodeURIComponent('Hi, I am interested in '+p.name+' ('+p.sku+')')}" target="_blank">WhatsApp</a> </div> </div>`; document.getElementById('contactForm').innerHTML = ` <label>Name</label><input id="name" class="input"/> <label>Email</label><input id="email" class="input"/> <label>Phone</label><input id="phone" class="input"/> <label>Message</label><textarea id="msg" class="input" rows="4"></textarea> <div class="btnrow"><button class="btn" onclick="sendContact('${p.sku}')">Send</button></div>`; } async function sendContact(sku){ const c = await cfg; const payload = {name:document.getElementById('name').value,email:document.getElementById('email').value,phone:document.getElementById('phone').value,message:document.getElementById('msg').value,sku}; const res = await fetch(`${c.APP_SCRIPT_BASE}?route=contact`,{method:'POST',body:JSON.stringify(payload)}); const ok = await res.json(); alert(ok.status||'Sent'); } async function payfastCheckout(sku){ const c = await cfg; const res = await fetch(`${c.APP_SCRIPT_BASE}?route=payfastInit&sku=${encodeURIComponent(sku)}`); const pf = await res.json(); const form = document.createElement('form'); form.action = pf.processUrl; form.method = 'POST'; for(const [k,v] of Object.entries(pf.fields)){ const input = document.createElement('input'); input.type='hidden'; input.name=k; input.value=v; form.appendChild(input); } document.body.appendChild(form); form.submit(); } load();