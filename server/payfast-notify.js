/** PayFast ITN Handler (Serverless Template) */
export default { async fetch(request, env){ if(request.method!=='POST') return new Response('Method Not Allowed',{status:405}); const body = await request.text(); const params = new URLSearchParams(body); const passphrase = env.PAYFAST_PASSPHRASE; const signature = params.get('signature'); const pairs = []; for(const [k,v] of params){ if(k!=='signature'){ pairs.push(`${k}=${v}`); } } const query = pairs.join('&') + (passphrase? `&passphrase=${encodeURIComponent(passphrase)}`:''); const digest = await crypto.subtle.digest('SHA-512', new TextEncoder().encode(query)); const hex = Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join(''); if(hex!==signature) return new Response('Invalid signature',{status:400}); return new Response('OK'); } }
