/** Public Web App — Products & Contact & PayFast ITN */
const ORIGIN_WHITELIST=['https://wykiesautomation.co.za','https://www.wykiesautomation.co.za'];
function doGet(e){return handle_(e);}function doPost(e){return handle_(e);}function doOptions(e){return buildResponse_({ok:true},204,e);}function handle_(e){const path=(e.parameter.path||'').toString();if(e?.parameter?.sheetId)PropertiesService.getScriptProperties().setProperty('SHEET_ID',e.parameter.sheetId);if(path==='/cms/products'&&!(e.postData))return productsList_(e);if(path==='/forms/contact'&&e.postData)return contactSubmit_(e);if(path==='/itn/payfast'&&e.postData)return payfastItn_(e);return buildResponse_({message:'Not found'},404,e);}function getSheet_(){const id=PropertiesService.getScriptProperties().getProperty('SHEET_ID');return SpreadsheetApp.openById(id);}function productsList_(e){const ss=getSheet_();const sh=ss.getSheetByName('Products');const rows=sh.getDataRange().getValues();const [header,...data]=rows;const idx=Object.fromEntries(header.map((h,i)=>[h,i]));const items=data.filter(r=>r[idx['code']]).map(r=>({code:r[idx['code']],name:r[idx['name']],price:r[idx['price']],image:r[idx['image']]}));return buildResponse_(items,200,e);}function contactSubmit_(e){const data=JSON.parse(e.postData.contents);const {name,email,product,message}=data;const ss=getSheet_();const sh=ss.getSheetByName('Payments')||ss.insertSheet('Payments');sh.appendRow([new Date(),name,email,product,message]);MailApp.sendEmail('wykiesautomation@gmail.com',`New contact / pre-order: ${product}`,`Name: ${name}
Email: ${email}
Product: ${product}

${message||''}`);if(email){MailApp.sendEmail(email,'Thanks — Wykies Automation','We received your message and will reply shortly.');}return buildResponse_({message:'Submitted'},200,e);}function payfastItn_(e){const params=e.postData.contents;const parsed=Object.fromEntries(params.split('&').map(p=>p.split('=').map(decodeURIComponent)));const passphrase=PropertiesService.getScriptProperties().getProperty('PAYFAST_PASSPHRASE')||'';const keys=Object.keys(parsed).filter(k=>k!=='signature').sort();const query=keys.map(k=>`${k}=${encodeURIComponent(parsed[k]).replace(/%20/g,'+')}`).join('&')+(passphrase?`&passphrase=${encodeURIComponent(passphrase).replace(/%20/g,'+')}`:'');const sig=Utilities.computeDigest(Utilities.DigestAlgorithm.MD5,query).map(b=>('0'+(b&0xFF).toString(16)).slice(-2)).join('');if(sig.toLowerCase()!==(parsed.signature||'').toLowerCase())return buildResponse_({ok:false,message:'Bad signature'},400,e);const ss=getSheet_();const sh=ss.getSheetByName('Payments')||ss.insertSheet('Payments');sh.appendRow([new Date(),parsed.pf_payment_id,parsed.m_payment_id,parsed.amount_gross,parsed.email_address,parsed.item_name]);MailApp.sendEmail('wykiesautomation@gmail.com','PayFast payment received',JSON.stringify(parsed,null,2));return buildResponse_({ok:true},200,e);}function buildResponse_(body,status,e){const origin=(e?.parameter?.origin)||(e?.headers&&e.headers['Origin'])||'';const allow=ORIGIN_WHITELIST.includes(origin)?origin:'*';return ContentService.createTextOutput(typeof body==='string'?body:JSON.stringify(body)).setMimeType(ContentService.MimeType.JSON).setHeaders({'Access-Control-Allow-Origin':allow,'Access-Control-Allow-Methods':'GET,POST,OPTIONS','Access-Control-Allow-Headers':'Content-Type,Authorization'}).setStatusCode(status||200);}